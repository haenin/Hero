<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
<pre>
  Xml Name: NotificationMapper.xml
  Description: 알림 관리 Mybatis Mapper

  History
  2025/12/12 (혜원) 최초 작성
  2025/12/15 (혜원) 알림 삭제 관련 쿼리 추가
  2025/12/22 (혜원) JWT 리팩토링이랑 조회 조건 수정한 내용을 추가
  2025/12/22 (혜원) insert 시 생성된 ID 자동 매핑 설정 추가 (useGeneratedKeys)
</pre>

  @author 혜원
  @version 1.0
-->

<mapper namespace="com.c4.hero.domain.notification.mapper.NotificationMapper">
    
    <resultMap id="notificationResultMap" type="com.c4.hero.domain.notification.dto.NotificationDTO">
        <id property="notificationId" column="notification_id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="message" column="message"/>
        <result property="link" column="link"/>
        <result property="isRead" column="is_read"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="readAt" column="read_at"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="employeeId" column="employee_id"/>
        <result property="attendanceId" column="attendance_id"/>
        <result property="payrollId" column="payroll_id"/>
        <result property="documentId" column="document_id"/>
        <result property="evaluationId" column="evaluation_id"/>
    </resultMap>

    <insert id="insertNotification"
            useGeneratedKeys="true"
            keyProperty="notificationId"
            parameterType="com.c4.hero.domain.notification.dto.NotificationDTO">
        INSERT INTO tbl_notification (
            type,
            title,
            message,
            link,
            is_read,
            created_at,
            employee_id,
            attendance_id,
            payroll_id,
            document_id,
            evaluation_id
        ) VALUES (
            #{type},
            #{title},
            #{message},
            #{link},
            false,
            NOW(),
            #{employeeId},
            #{attendanceId},
            #{payrollId},
            #{documentId},
            #{evaluationId}
        );
    </insert>

    <!-- 알림 목록 조회 -->
    <select id="selectAllNotification" resultMap="notificationResultMap" parameterType="int">
        SELECT *
          FROM tbl_notification
         WHERE employee_id = #{employeeId}
           AND is_deleted = false
         ORDER BY created_at DESC
    </select>

    <!-- 미읽은 알림 개수 조회 -->
    <select id="countUnreadNotification" resultType="int" parameterType="int">
        SELECT COUNT(*)
          FROM tbl_notification
         WHERE employee_id = #{employeeId}
           AND is_read = false
           AND is_deleted = false
    </select>

    <!-- 알림 읽음 처리 -->
    <update id="updateIsRead" parameterType="int">
        UPDATE tbl_notification
           SET is_read = true,
               read_at = NOW()
         WHERE employee_id = #{employeeId}
           AND is_read = false;
    </update>

    <!-- 모든 알림 읽음 처리 -->
    <update id="updateAllIsRead" parameterType="int">
        UPDATE tbl_notification
           SET is_read = true,
               read_at = NOW()
         WHERE employee_id = #{employeeId}
           AND is_read = false;
    </update>

    <!-- 알림 소프트 삭제 -->
    <update id="softDeleteNotification">
        UPDATE tbl_notification
        SET is_deleted = TRUE,
            deleted_at = NOW()
        WHERE notification_id = #{notificationId}
    </update>

    <!-- 소프트 삭제된 알림 복구 -->
    <update id="updateNotification">
        UPDATE tbl_notification
        SET is_deleted = FALSE,
            deleted_at = NULL
        WHERE notification_id = #{notificationId}
    </update>

    <!-- 알림 영구 삭제 -->
    <delete id="deleteNotification">
        DELETE FROM tbl_notification
        WHERE notification_id = #{notificationId}
    </delete>

    <!-- 소프트 삭제된 알림 목록 조회 -->
    <select id="selectDeletedNotifications" resultMap="notificationResultMap">
        SELECT *
        FROM tbl_notification
        WHERE employee_id = #{employeeId}
          AND is_deleted = TRUE
        ORDER BY deleted_at DESC
    </select>

    <!-- 30일 지난 소프트 삭제 알림 조회 -->
    <select id="selectOldDeletedNotifications" resultMap="notificationResultMap">
        SELECT *
        FROM tbl_notification
        WHERE is_deleted = TRUE
          AND deleted_at <![CDATA[<]]> #{thirtyDaysAgo}
    </select>

</mapper>