<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 * <pre>
 * Mapper Name : PayrollAttendanceMapper.xml
 * Description : 급여 계산을 위한 근태 연계 조회 매퍼
 *
 * 역할
 *  - 사원의 기본급 조회
 *  - 특정 월 기준 근태 데이터 집계
 *    · 근무 일수
 *    · 총 근무 시간(분 단위)
 *
 * 사용 위치
 *  - 급여 배치 계산 시 근태 데이터 검증 및 급여 산출 로직
 *
 * History
 *  2025/12/15 - 동근 최초 작성
 * </pre>
 * @author 동근
 * @version 1.0
 -->
<mapper namespace="com.c4.hero.domain.payroll.integration.attendance.mapper.PayrollAttendanceMapper">

    <!--
     * 사원의 기본급 조회
     *
     * @param employeeId 사원 ID
     * @return base_salary (정수형 기본급)
     *
     * 사용 목적
     *  - 월 급여 계산의 기준 금액으로 사용
     -->
<select id="selectBaseSalary" resultType="java.lang.Integer">
        SELECT base_salary
        FROM tbl_employee
        WHERE employee_id = #{employeeId}
    </select>


    <!--
    * 특정 월의 근태 기록 수(근무 일수 개념)
    *
    * @param employeeId 사원 ID
    * @param start 조회 시작일 (YYYY-MM-01)
    * @param end   조회 종료일 (YYYY-MM-DD)
    * @return 근태 기록 건수
    *
    * 사용 목적
    *  - 월 근무 일수 계산
    *  - 급여 계산 전 근태 데이터 존재 여부 검증
    -->
    <select id="countAttendanceInMonth" resultType="int">
        SELECT COUNT(DISTINCT work_date)
        FROM tbl_attendance
        WHERE employee_id = #{employeeId}
        AND work_date <![CDATA[>=]]> #{start}
        AND work_date <![CDATA[<=]]> #{end}
    </select>


    <!--
   * 특정 월의 총 근무 시간 합계 (분 단위)
   *
   * @param employeeId 사원 ID
   * @param start 조회 시작일 (YYYY-MM-01)
   * @param end   조회 종료일 (YYYY-MM-DD)
   * @return 총 근무 시간(분), 데이터 없을 경우 0 반환
   *
   * 주의 사항
   *  - 출근/퇴근 시간이 모두 존재하는 근태 데이터만 집계
   *  - NULL 방지를 위해 COALESCE 처리
   *
   * 사용 목적
   *  - 시급제/초과근무 수당 계산
   *  - 월 근로 시간 기반 급여 산출
   -->
    <select id="sumWorkedMinutesInMonth" resultType="int">
        SELECT COALESCE(SUM(
            CASE
                -- work_duration(분)이 있으면 그 값을 우선 사용
              WHEN work_duration IS NOT NULL THEN work_duration
            -- 없으면 출/퇴근 시간으로 계산
                WHEN start_time IS NOT NULL AND end_time IS NOT NULL THEN TIMESTAMPDIFF(MINUTE, start_time, end_time)
                ELSE 0
                END), 0)
        FROM tbl_attendance
        WHERE employee_id = #{employeeId}
        AND work_date <![CDATA[>=]]> #{start}
        AND work_date <![CDATA[<=]]> #{end}
    </select>


        <!--
     * 특정 월의 근무일수(표시/검증용)
     * - 중복 근태가 있을 수 있으므로 work_date 기준 DISTINCT
     -->
        <select id="countWorkDaysInMonth" resultType="int">
            SELECT COUNT(DISTINCT work_date)
                FROM tbl_attendance
                   WHERE employee_id = #{employeeId}
                   AND work_date <![CDATA[>=]]> #{start}
                   AND work_date <![CDATA[<=]]> #{end}
        </select>

</mapper>
