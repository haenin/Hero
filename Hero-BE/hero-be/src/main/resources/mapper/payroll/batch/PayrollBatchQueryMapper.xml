<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 * <pre>
 * Mapper Name : PayrollBatchQueryMapper.xml
 * Description : 급여 배치 조회 전용 매퍼
 *
 * 역할
 *  - 급여 배치 목록 조회 (월 / 상태 필터)
 *  - 급여 배치 상세 정보 및 처리 현황 집계
 *  - 배치별 사원 급여 계산 결과 조회
 *  - 배치 생성 시 대상 사원 목록 조회
 *
 * 설계 의도
 *  - 급여 배치 조회는 MyBatis로 분리
 *
 * 사용 위치
 *  - 관리자(Admin) 급여 배치 관리 화면
 *
 * History
 *  2025/12/15 - 동근 최초 작성
 * </pre>
 * @author 동근
 * @version 1.0
 -->
<mapper namespace="com.c4.hero.domain.payroll.batch.mapper.PayrollBatchQueryMapper">

    <!--
        *  급여 배치 목록 조회
        *
        * @param month  조회할 급여월 (YYYY-MM), 선택 조건
        * @param status 배치 상태 (READY / CALCULATED / CONFIRMED), 선택 조건
        * @return 급여 배치 목록
        *
        * 기능 설명
        *  - 급여월 및 상태 조건에 따른 배치 목록 조회
        *  - 최신 생성 배치가 상단에 오도록 정렬
        *
        * 사용 화면
        *  - 관리자 -> 급여 배치 관리 -> 배치 목록
        -->
    <select id="selectBatchList"
            resultType="com.c4.hero.domain.payroll.batch.dto.PayrollBatchListResponseDTO">
        SELECT
        b.batch_id     AS batchId,
        b.salary_month AS salaryMonth,
        b.status       AS status,
        b.created_at   AS createdAt,
        b.updated_at   AS updatedAt,
        b.closed_at    AS closedAt,
        /* 배치 요약 집계 (계산/확정/지급 데이터 기준) */
        COALESCE(SUM(CASE
        WHEN p.status IN ('CALCULATED','CONFIRMED','PAID')
        THEN (p.base_salary + p.overtime_pay + p.allowance_total + p.bonus)
        ELSE 0
        END), 0) AS totalGrossPay,

        COALESCE(SUM(CASE
        WHEN p.status IN ('CALCULATED','CONFIRMED','PAID') THEN p.deduction_total
        ELSE 0
        END), 0) AS totalDeduction,

        COALESCE(SUM(CASE
        WHEN p.status IN ('CALCULATED','CONFIRMED','PAID') THEN p.total_pay
        ELSE 0
        END), 0) AS totalNetPay,
        b.created_by   AS createdBy,
        ec.employee_name AS createdByName,

        b.approved_by  AS approvedBy,
        ea.employee_name AS approvedByName,
        b.approved_at  AS approvedAt,
        b.paid_by      AS paidBy,
        ep.employee_name AS paidByName,
        b.paid_at      AS paidAt
        FROM tbl_payroll_batch b
        LEFT JOIN tbl_payroll p ON p.batch_id = b.batch_id
        LEFT JOIN tbl_employee ec ON ec.employee_id = b.created_by
        LEFT JOIN tbl_employee ea ON ea.employee_id = b.approved_by
        LEFT JOIN tbl_employee ep ON ep.employee_id = b.paid_by
        <where>
            <if test="month != null and month != ''">
                AND b.salary_month = #{month}
            </if>
            <if test="status != null and status != ''">
                AND b.status = #{status}
            </if>
        </where>
        GROUP BY
        b.batch_id, b.salary_month, b.status, b.created_at, b.updated_at, b.closed_at,
        b.created_by, ec.employee_name,
        b.approved_by, ea.employee_name, b.approved_at,
        b.paid_by, ep.employee_name, b.paid_at
        ORDER BY b.created_at DESC, b.batch_id DESC
    </select>

    <!--
    *  급여 배치 상세 조회 + 처리 현황 집계
    *
    * @param batchId 급여 배치 ID
    * @return 배치 상세 정보 + 사원별 급여 처리 상태 집계
    *
    * 집계 항목
    *  - totalEmployeeCount - 배치에 포함된 전체 사원 수
    *  - calculatedCount  - 계산 완료(CALCULATED) 사원 수
    *  - failedCount     - 계산 실패(FAILED) 사원 수
    *  - confirmedCount   - 확정(CONFIRMED) 사원 수
    *
    *
    * 사용 화면
    *  - 관리자 -> 급여 배치 관리 -> 배치 상세
    -->
    <select id="selectBatchDetail"
            resultType="com.c4.hero.domain.payroll.batch.dto.PayrollBatchDetailResponseDTO">
        SELECT
            b.batch_id     AS batchId,
            b.salary_month AS salaryMonth,
            b.status       AS status,
            b.created_at   AS createdAt,
            b.updated_at   AS updatedAt,
            b.closed_at    AS closedAt,

            COUNT(p.payroll_id) AS totalEmployeeCount,
            SUM(CASE WHEN p.status = 'CALCULATED' THEN 1 ELSE 0 END) AS calculatedCount,
            SUM(CASE WHEN p.status = 'FAILED'     THEN 1 ELSE 0 END) AS failedCount,
            SUM(CASE WHEN p.status = 'CONFIRMED'  THEN 1 ELSE 0 END) AS confirmedCount

        FROM tbl_payroll_batch b
                 LEFT JOIN tbl_payroll p ON p.batch_id = b.batch_id
        WHERE b.batch_id = #{batchId}
        GROUP BY
            b.batch_id, b.salary_month, b.status, b.created_at, b.updated_at, b.closed_at
    </select>

    <!--
    * 배치별 사원 급여 계산 결과 목록 조회
    *
    * @param batchId 급여 배치 ID
    * @return 배치에 포함된 사원 급여 계산 결과 목록
    *
    * 조회 항목
    *  - 사원 정보 (이름, 부서)
    *  - 급여 상태 (READY / CALCULATED / FAILED / CONFIRMED)
    *  - 급여 금액 정보 (기본급, 수당, 공제, 실수령액)
    *
    * 사용 화면
    *  - 관리자 -> 급여 배치 관리 -> 급여 계산 결과 탭
    -->
    <select id="selectPayrollEmployees"
            resultType="com.c4.hero.domain.payroll.batch.dto.PayrollEmployeeResultResponseDTO">
        SELECT
            p.payroll_id      AS payrollId,
            p.employee_id     AS employeeId,
            e.employee_name   AS employeeName,
            d.department_name AS departmentName,
            p.salary_month    AS salaryMonth,
            p.status          AS status,
            p.base_salary     AS baseSalary,

            /* 연장수당은 참고용으로 유지 */
            p.overtime_pay    AS overtimePay,

            /* 지급항목 전체 = 수당 + 연장 + 상여 */
            (p.allowance_total + p.overtime_pay + p.bonus) AS allowanceTotal,

            p.deduction_total AS deductionTotal,
            p.total_pay       AS totalPay,

            (
                SELECT COUNT(DISTINCT a.work_date)
                FROM tbl_attendance a
                WHERE a.employee_id = p.employee_id
                  AND a.work_date <![CDATA[>=]]> CONCAT(p.salary_month, '-01')
                  AND a.work_date <![CDATA[<=]]> LAST_DAY(CONCAT(p.salary_month, '-01'))
            ) AS attendanceDays,

            p.error_message AS errorMessage
        FROM tbl_payroll p
                 JOIN tbl_employee e ON e.employee_id = p.employee_id
                 LEFT JOIN tbl_department d ON d.department_id = e.department_id
        WHERE p.batch_id = #{batchId}
        ORDER BY e.employee_id ASC
    </select>


    <!--
      * 급여 배치 대상 사원 목록 조회
      *
      * @return 재직 중인 사원 목록
      *
      * 조회 조건
      *  - 재직 상태(e.status = 'A') 사원만 포함
      *
      * 사용 목적
      *  - 급여 배치 생성 시 대상 사원 리스트 구성
      *  - 급여 계산 대상 사원 초기 세팅
      -->
    <select id="selectBatchTargetEmployees"
            resultType="com.c4.hero.domain.payroll.batch.dto.PayrollBatchTargetEmployeeResponseDTO">
        SELECT
            e.employee_id   AS employeeId,
            e.employee_name AS employeeName,
            d.department_name AS departmentName
        FROM tbl_employee e
                 LEFT JOIN tbl_department d ON e.department_id = d.department_id
        WHERE e.status = 'A'
          AND e.employee_id != 1
    </select>
</mapper>