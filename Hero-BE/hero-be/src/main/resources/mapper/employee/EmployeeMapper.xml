<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
<pre>
  Xml Name: EmployeeMapper.xml
  Description: 직원 관리 Mybatis Mapper

  History
  2025/12/09 (승건) 최초 작성
  2025/12/28 (혜원) 프로필 관련 쿼리 추가
  2025/12/30 (승건) SecretKey를 변수로 받아 정상적으로 조회 되도록 수정
</pre>

  @author 승건
  @version 2.0
-->
<mapper namespace="com.c4.hero.domain.employee.mapper.EmployeeMapper">

    <resultMap id="EmployeeResultMap" type="com.c4.hero.domain.employee.entity.Employee">
        <id property="employeeId" column="employee_id"/>
        <result property="employeeNumber" column="employee_number"/>
        <result property="employeeName" column="employee_name"/>
        <result property="email" column="email" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="phone" column="phone" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="birthDate" column="birth_date"/>
        <result property="gender" column="gender"/>
        <result property="status" column="status" typeHandler="com.c4.hero.domain.employee.type.handler.EmployeeStatusTypeHandler"/>
        <result property="contractType" column="contract_type"/>
        <result property="address" column="address" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="hireDate" column="hire_date"/>
        <result property="terminationDate" column="termination_date"/>
        <result property="retentionExpireAt" column="retention_expire_at"/>
        <result property="sealImageUrl" column="seal_image_url"/>
        <result property="imagePath" column="image_path"/>
        <result property="evaluationPoint" column="evaluation_point"/>
        <result property="baseSalary" column="base_salary"/>

        <!-- 연관 관계 매핑 -->
        <association property="employeeDepartment" javaType="com.c4.hero.domain.employee.entity.EmployeeDepartment">
            <id property="departmentId" column="department_id"/>
            <result property="departmentName" column="department_name"/>
        </association>

        <association property="grade" javaType="com.c4.hero.domain.employee.entity.Grade">
            <id property="gradeId" column="grade_id"/>
            <result property="grade" column="grade_name"/>
        </association>

        <association property="jobTitle" javaType="com.c4.hero.domain.employee.entity.JobTitle">
            <id property="jobTitleId" column="job_title_id"/>
            <result property="jobTitle" column="job_title_name"/>
        </association>
    </resultMap>

    <!-- 부서 경로를 포함하는 ResultMap -->
    <resultMap id="EmployeeWithDeptPathResultMap" type="com.c4.hero.domain.employee.entity.Employee" extends="EmployeeResultMap">
        <result property="departmentPath" column="department_path"/>
    </resultMap>

    <sql id="employeeColumns">
        e.employee_id, e.employee_number, e.employee_name, e.email, e.phone,
        e.birth_date, e.gender, e.status, e.contract_type, e.address,
        e.hire_date, e.image_path, e.evaluation_point,
        d.department_id, d.department_name,
        g.grade_id, g.grade AS grade_name,
        jt.job_title_id, jt.job_title AS job_title_name
    </sql>

    <sql id="employeeJoins">
        FROM
            tbl_employee e
        LEFT JOIN
            tbl_department d ON e.department_id = d.department_id
        LEFT JOIN
            tbl_grade g ON e.grade_id = g.grade_id
        LEFT JOIN
            tbl_job_title jt ON e.job_title_id = jt.job_title_id
    </sql>

    <sql id="searchConditions">
        <where>
            e.department_id != 0
            <choose>
                <when test="resigningExpected == 3">
                    AND e.status = 'R' <!-- 퇴사자만 조회 -->
                </when>
                <otherwise>
                    AND e.status = 'A' <!-- 기본적으로 재직자 조회 -->
                    <choose>
                        <when test="resigningExpected == 1">
                            <!-- 미포함: 퇴사 예정이 아닌 직원만 -->
                            AND e.termination_date IS NULL
                        </when>
                        <when test="resigningExpected == 2">
                            <!-- 퇴사 예정자만 -->
                            AND e.termination_date IS NOT NULL
                        </when>
                        <!-- 그 외(0 또는 null): 모든 재직자(퇴사 예정자 포함) -->
                    </choose>
                </otherwise>
            </choose>

            <if test="departmentName != null and departmentName != ''">
                AND d.department_name LIKE CONCAT('%', #{departmentName}, '%')
            </if>
            <if test="jobTitleName != null and jobTitleName != ''">
                AND jt.job_title LIKE CONCAT('%', #{jobTitleName}, '%')
            </if>
            <if test="gradeName != null and gradeName != ''">
                AND g.grade LIKE CONCAT('%', #{gradeName}, '%')
            </if>
            <if test="employeeName != null and employeeName != ''">
                AND e.employee_name LIKE CONCAT('%', #{employeeName}, '%')
            </if>
        </where>
    </sql>

    <select id="findWithPaging" resultMap="EmployeeResultMap" parameterType="com.c4.hero.domain.employee.dto.request.EmployeeSearchDTO">
        SELECT
        <include refid="employeeColumns"/>
        <include refid="employeeJoins"/>
        <include refid="searchConditions"/>
        ORDER BY
        e.grade_id DESC,
        e.hire_date ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="count" resultType="int" parameterType="com.c4.hero.domain.employee.dto.request.EmployeeSearchDTO">
        SELECT COUNT(*)
        <include refid="employeeJoins"/>
        <include refid="searchConditions"/>
    </select>

    <select id="findById" resultMap="EmployeeWithDeptPathResultMap" parameterType="int">
        WITH RECURSIVE DepartmentPath AS (
            SELECT
                department_id,
                department_name,
                parent_department_id,
                CAST(department_name AS CHAR(255)) AS path
            FROM tbl_department
            WHERE parent_department_id IS NULL
            UNION ALL
            SELECT
                d.department_id,
                d.department_name,
                d.parent_department_id,
                CONCAT(dp.path, ' > ', d.department_name)
            FROM tbl_department d
                     JOIN DepartmentPath dp ON d.parent_department_id = dp.department_id
        )
        SELECT
            e.employee_id, e.employee_number, e.employee_name, e.email, e.phone,
            e.birth_date, e.gender, e.status, e.contract_type, e.address,
            e.hire_date, e.image_path, e.evaluation_point, e.base_salary,
            e.termination_date, e.retention_expire_at, e.seal_image_url,
            d.department_id, d.department_name,
            g.grade_id, g.grade AS grade_name,
            jt.job_title_id, jt.job_title AS job_title_name,
            dp.path AS department_path
        FROM
            tbl_employee e
                LEFT JOIN
            tbl_department d ON e.department_id = d.department_id
                LEFT JOIN
            tbl_grade g ON e.grade_id = g.grade_id
                LEFT JOIN
            tbl_job_title jt ON e.job_title_id = jt.job_title_id
                LEFT JOIN
            DepartmentPath dp ON e.department_id = dp.department_id
        WHERE e.employee_id = #{employeeId}
    </select>

    <select id="findAllDepartmentNames" resultType="string">
        SELECT DISTINCT department_name
        FROM tbl_department
        WHERE department_id != 0
        ORDER BY department_name
    </select>

    <select id="findAllGradeNames" resultType="string">
        SELECT DISTINCT grade
        FROM tbl_grade
        WHERE grade_id != 0
        ORDER BY grade_id
    </select>

    <select id="findAllJobTitleNames" resultType="string">
        SELECT DISTINCT job_title
        FROM tbl_job_title
        WHERE job_title_id != 0
        ORDER BY job_title_id
    </select>

    <!--
        직원 프로필 관련 쿼리
        @author 혜원
        @since 2025/12/28
        <result property="performance" column="performance"/>
        <result property="profileImageUrl" column="image_path"/>
    -->

    <!-- 직원 프로필 정보 조회 ResultMap -->
    <resultMap id="employeeProfileResultMap" type="com.c4.hero.domain.employee.dto.response.EmployeeProfileResponseDTO">
        <result property="employeeNumber" column="employee_number"/>
        <result property="employeeName" column="employee_name"/>
        <result property="birthDate" column="birth_date"/>
        <result property="contractType" column="contract_type"/>
        <result property="position" column="job_title"/>
        <result property="rank" column="grade"/>
        <result property="departmentId" column="department_id"/>
        <result property="department" column="department_name"/>
        <result property="team" column="team_name"/>
        <result property="email" column="email"/>
        <result property="officePhone" column="office_phone"/>
        <result property="mobile" column="mobile"/>
        <result property="address" column="address"/>
        <result property="hireDate" column="hire_date"/>
        <result property="yearsOfService" column="years_of_service"/>
        <result property="salary" column="base_salary"/>
        <result property="status" column="status"/>
        <result property="sealImageUrl" column="seal_image_url"/>
        <result property="profileImageUrl" column="image_path"/>
    </resultMap>

    <!--
        직원 ID로 프로필 정보 조회
    -->
    <select id="findProfileByEmployeeId" resultMap="employeeProfileResultMap">
        SELECT
            e.employee_number,
            e.employee_name,
            e.birth_date,
            e.contract_type,
            jt.job_title,
            g.grade,
            d.department_id,
            d.department_name,
            COALESCE(sub_d.department_name, d.department_name) as team_name,
            CAST(AES_DECRYPT(e.email, #{secretKey}) AS CHAR) as email,
            d.department_phone as office_phone,
            CAST(AES_DECRYPT(e.phone, #{secretKey}) AS CHAR) as mobile,
            CAST(AES_DECRYPT(e.address, #{secretKey}) AS CHAR) as address,
            e.hire_date,
            TIMESTAMPDIFF(YEAR, e.hire_date, CURDATE()) as years_of_service,
            e.base_salary,
            CASE
                WHEN e.status = 'A' THEN '재직'
                WHEN e.status = 'O' THEN '휴직'
                WHEN e.status = 'R' THEN '퇴직'
                ELSE '알 수 없음'
                END as status,
            CONCAT(
                    CASE
                        WHEN e.evaluation_point >= 90 THEN 'S'
                        WHEN e.evaluation_point >= 80 THEN 'A'
                        WHEN e.evaluation_point >= 70 THEN 'B'
                        WHEN e.evaluation_point >= 60 THEN 'C'
                        ELSE 'D'
                        END,
                    '등급'
            ) as performance,
            e.image_path,
            e.seal_image_url
        FROM tbl_employee e
                 LEFT JOIN tbl_job_title jt ON e.job_title_id = jt.job_title_id
                 LEFT JOIN tbl_grade g ON e.grade_id = g.grade_id
                 LEFT JOIN tbl_department d ON e.department_id = d.department_id
                 LEFT JOIN tbl_department sub_d ON d.parent_department_id = sub_d.department_id
        WHERE e.employee_id = #{employeeId}
          AND e.status != 'R'
    </select>

    <!--
        사원번호로 프로필 정보 조회
    -->
    <select id="findProfileByEmployeeNumber" resultMap="employeeProfileResultMap">
        SELECT
            e.employee_number,
            e.employee_name,
            e.birth_date,
            e.contract_type,
            jt.job_title,
            g.grade,
            d.department_id,
            d.department_name,
            COALESCE(sub_d.department_name, d.department_name) as team_name,
            CAST(AES_DECRYPT(e.email, #{secretKey}) AS CHAR) as email,
            d.department_phone as office_phone,
            CAST(AES_DECRYPT(e.phone, #{secretKey}) AS CHAR) as mobile,
            CAST(AES_DECRYPT(e.address, #{secretKey}) AS CHAR) as address,
            e.hire_date,
            TIMESTAMPDIFF(YEAR, e.hire_date, CURDATE()) as years_of_service,
            e.base_salary,
            CASE
                WHEN e.status = 'A' THEN '재직'
                WHEN e.status = 'O' THEN '휴직'
                WHEN e.status = 'R' THEN '퇴직'
                ELSE '알 수 없음'
                END as status,
            CONCAT(
                    CASE
                        WHEN e.evaluation_point >= 90 THEN 'S'
                        WHEN e.evaluation_point >= 80 THEN 'A'
                        WHEN e.evaluation_point >= 70 THEN 'B'
                        WHEN e.evaluation_point >= 60 THEN 'C'
                        ELSE 'D'
                        END,
                    '등급'
            ) as performance,
            e.image_path,
            e.seal_image_url
        FROM tbl_employee e
                 LEFT JOIN tbl_job_title jt ON e.job_title_id = jt.job_title_id
                 LEFT JOIN tbl_grade g ON e.grade_id = g.grade_id
                 LEFT JOIN tbl_department d ON e.department_id = d.department_id
                 LEFT JOIN tbl_department sub_d ON d.parent_department_id = sub_d.department_id
        WHERE e.employee_number = #{employeeNumber}
          AND e.status != 'R'
    </select>

    <!--
        연락처 정보 수정
        암호화 필드는 AES_ENCRYPT 사용
    -->
    <update id="updateContactInfo">
        UPDATE tbl_employee
        SET
        email = AES_ENCRYPT(#{dto.email}, #{secretKey}),
        phone = AES_ENCRYPT(#{dto.mobile}, #{secretKey}),
        <!-- 빈 문자열도 업데이트 -->
        <choose>
            <when test="dto.address != null and dto.address != ''">
                address = AES_ENCRYPT(#{dto.address}, #{secretKey}),
            </when>
            <otherwise>
                address = NULL,
            </otherwise>
        </choose>
        updated_at = CURRENT_TIMESTAMP
        WHERE employee_id = #{employeeId}
        AND status != 'R'
    </update>

    <!--
        직원 ID로 비밀번호 조회 (account 테이블)
    -->
    <select id="findPasswordHashByEmployeeId" resultType="string">
        SELECT a.password_hash
        FROM tbl_account a
        WHERE a.employee_id = #{employeeId}
          AND a.account_status = 'A'
    </select>

    <!--
        비밀번호 업데이트 (account 테이블)
    -->
    <update id="updatePasswordHash">
        UPDATE tbl_account
        SET
            password_hash = #{newPasswordHash},
            password_change_required = 0,
            password_changed_at = CURRENT_TIMESTAMP,
            updated_at = CURRENT_TIMESTAMP
        WHERE employee_id = #{employeeId}
          AND account_status = 'A'
    </update>

    <!--
    직원 ID로 직인 이미지 URL 조회
    -->
    <select id="findSealImageUrlByEmployeeId" resultType="string">
        SELECT seal_image_url
        FROM tbl_employee
        WHERE employee_id = #{employeeId}
          AND status != 'R'
    </select>

    <!--
        직인 이미지 URL 업데이트
    -->
    <update id="updateSealImageUrl">
        UPDATE tbl_employee
        SET
            seal_image_url = #{sealImageUrl},
            updated_at = CURRENT_TIMESTAMP
        WHERE employee_id = #{employeeId}
          AND status != 'R'
    </update>

    <!--
       직인 이미지 생성을 위한 이름 조회
   -->
    <select id="findEmployeeNameById" parameterType="int" resultType="string">
        SELECT employee_name
        FROM tbl_employee
        WHERE employee_id = #{employeeId}
          AND status != 'R'
    </select>
</mapper>