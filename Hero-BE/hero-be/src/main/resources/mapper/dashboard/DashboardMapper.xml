<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  <pre>
  Xml Name  : DashboardMapper
  Description: 대시보드 통계 관련 MyBatis 매퍼 XML

  History
  2025/12/26 (혜원) 최초 작성
  2025/12/29 (지윤) 출퇴근 시간 부분 수정

  @author 혜원
  @version 1.0
-->

<mapper namespace="com.c4.hero.domain.dashboard.mapper.DashboardMapper">

    <!-- 1) 출퇴근 상태 ResultMap - 사용하지 않으므로 삭제하거나 주석 처리 -->
    <!--
    <resultMap id="ClockStatusMap" type="com.c4.hero.domain.dashboard.dto.ClockStatusDTO">
        <result property="attendanceId" column="attendance_id"/>
        <result property="workDate"     column="work_date"/>
        <result property="startTime"    column="start_time"/>
        <result property="endTime"      column="end_time"/>
        <result property="state"        column="state"/>
        <result property="isClockedIn"  column="is_clocked_in"/>
        <result property="isClockedOut" column="is_clocked_out"/>
        <result property="workDuration" column="work_duration"/>
        <result property="workSystemTemplateId" column="work_system_template_id"/>
    </resultMap>
    -->

    <!-- 2) 출근 기록 INSERT -->
    <insert id="insertClockIn" parameterType="map">
        INSERT INTO tbl_attendance (
        employee_id,
        department_id,
        work_date,
        start_time,
        end_time,
        state,
        work_system_type_id,
        work_system_template_id  <!-- 이 줄이 있나요? -->
        ) VALUES (
        #{employeeId},
        #{departmentId},
        #{dto.workDate},
        CAST(#{dto.startTime} AS TIME),
        NULL,
        CASE
        WHEN CAST(#{dto.startTime} AS TIME) > CAST('09:00:00' AS TIME) THEN '지각'
        ELSE '정상'
        END,
        #{dto.workSystemTypeId},           <!-- workSystemTypeId -->
        #{dto.workSystemTemplateId}        <!-- workSystemTemplateId ← 이게 있나요? -->
        )
    </insert>

    <!-- 3) 퇴근 시각 UPDATE + 근무시간 저장 (휴게시간 차감 포함) -->
    <update id="updateClockOut" parameterType="map">
        UPDATE tbl_attendance att
            LEFT JOIN tbl_work_system_template wst
        ON att.work_system_template_id = wst.work_system_template_id
            SET
                att.end_time = CAST(#{dto.endTime} AS TIME),
                att.work_duration = #{dto.workDuration},
                att.state = CASE
                WHEN att.start_time IS NULL THEN '결근'
                WHEN att.start_time > COALESCE(wst.start_time, CAST('09:00:00' AS TIME)) THEN '지각'
                WHEN CAST(#{dto.endTime} AS TIME) &lt; COALESCE(wst.end_time, CAST('18:00:00' AS TIME)) THEN '조퇴'
                ELSE '정상'
        END
        WHERE att.employee_id = #{employeeId}
        AND att.work_date = #{dto.workDate}
        AND att.attendance_id = #{dto.attendanceId}
    </update>

    <!-- 4) 오늘 출퇴근 상태 조회 -->
    <select id="selectTodayStatus" resultType="com.c4.hero.domain.dashboard.dto.ClockStatusDTO">
        SELECT
            attendance_id AS attendanceId,
            work_date AS workDate,
            start_time AS startTime,
            end_time AS endTime,
            work_duration AS workDuration,
            state,
            CASE
                WHEN start_time IS NOT NULL THEN TRUE
                ELSE FALSE
                END AS isClockedIn,
            CASE
                WHEN end_time IS NOT NULL THEN TRUE
                ELSE FALSE
                END AS isClockedOut,
            work_system_template_id AS workSystemTemplateId
        FROM tbl_attendance
        WHERE employee_id = #{employeeId}
          AND work_date = #{workDate}
    </select>

    <!-- 5) 이번 주 근무 통계 조회 -->
    <select id="selectWeeklyStats" resultType="com.c4.hero.domain.dashboard.dto.WeeklyStatsDTO" parameterType="map">
        SELECT
            COALESCE(SUM(att.work_duration), 0) AS totalWorkMinutes,
            ROUND(COALESCE(SUM(att.work_duration), 0) / 60.0, 1) AS totalWorkHours,
            52 AS legalWeeklyHours,
            ROUND((COALESCE(SUM(att.work_duration), 0) / 60.0) / 52 * 100, 1) AS achievementRate,
            CASE
                WHEN TODAY.start_time IS NOT NULL AND TODAY.end_time IS NULL THEN TRUE
                ELSE FALSE
                END AS isWorkingToday,
            CASE
                WHEN TODAY.start_time IS NOT NULL AND TODAY.end_time IS NULL
                    THEN TIMESTAMPDIFF(MINUTE, TODAY.start_time, NOW())
                ELSE 0
                END AS todayWorkMinutes
        FROM (
                 SELECT #{startDate} AS week_start, #{endDate} AS week_end
             ) week_range
                 LEFT JOIN tbl_attendance att
                           ON att.employee_id = #{employeeId}
                               AND att.work_date BETWEEN week_range.week_start AND week_range.week_end
                               AND att.work_duration IS NOT NULL
                 LEFT JOIN (
            SELECT start_time, end_time
            FROM tbl_attendance
            WHERE employee_id = #{employeeId}
              AND work_date = CURDATE()
        ) TODAY ON 1=1
    </select>

    <!-- 6) 이번 달 요약 통계 조회 -->
    <select id="selectMonthlySummary" resultType="com.c4.hero.domain.dashboard.dto.MonthlySummaryDTO" parameterType="map">
        SELECT
            COALESCE(COUNT(DISTINCT att.work_date), 0) AS workDays,
            COALESCE(lv.remaining_days, 0) AS remainingAnnualLeave,
            COALESCE(SUM(CASE
                             WHEN vlog.status = 'APPROVED'
                                 THEN TIMESTAMPDIFF(DAY, vlog.start_date, vlog.end_date) + 1
                             ELSE 0
                END), 0) AS usedVacationDays
        FROM (
                 SELECT #{startDate} AS month_start, #{endDate} AS month_end
             ) month_range
                 LEFT JOIN tbl_attendance att
                           ON att.employee_id = #{employeeId}
                               AND att.work_date BETWEEN month_range.month_start AND month_range.month_end
                               AND att.work_duration IS NOT NULL
                 LEFT JOIN tbl_leave lv
                           ON lv.employee_id = #{employeeId}
                 LEFT JOIN tbl_vacation_log vlog
                           ON vlog.employee_id = #{employeeId}
                               AND vlog.start_date BETWEEN month_range.month_start AND month_range.month_end
    </select>

    <!-- 7) 출근 통계 조회 -->
    <select id="selectAttendanceStats" resultType="com.c4.hero.domain.dashboard.dto.AttendanceStatsDTO" parameterType="map">
        SELECT
            SUM(CASE WHEN att.state = '정상' THEN 1 ELSE 0 END) AS normalDays,
            SUM(CASE WHEN att.state = '지각' THEN 1 ELSE 0 END) AS lateDays,
            SUM(CASE WHEN att.state = '결근' THEN 1 ELSE 0 END) AS absentDays,
            SUM(CASE WHEN att.state = '조퇴' THEN 1 ELSE 0 END) AS earlyLeaveDays
        FROM tbl_attendance att
        WHERE att.employee_id = #{employeeId}
          AND att.work_date BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 8) 휴가 현황 조회 -->
    <select id="selectVacationStats" resultType="com.c4.hero.domain.dashboard.dto.VacationStatsDTO" parameterType="map">
        SELECT
            SUM(
                    CASE
                        WHEN vt.vacation_type_name LIKE '%연차%'
                            THEN TIMESTAMPDIFF(DAY, vlog.start_date, vlog.end_date) + 1
                        ELSE 0
                        END
            ) AS annualLeaveDays,
            SUM(
                    CASE
                        WHEN vt.vacation_type_name LIKE '%반차%'
                            THEN 0.5
                        ELSE 0
                        END
            ) AS halfDayDays,
            SUM(
                    CASE
                        WHEN vt.vacation_type_name LIKE '%병가%'
                            THEN TIMESTAMPDIFF(DAY, vlog.start_date, vlog.end_date) + 1
                        ELSE 0
                        END
            ) AS sickLeaveDays,
            SUM(
                    CASE
                        WHEN vt.vacation_type_name NOT LIKE '%연차%'
                            AND vt.vacation_type_name NOT LIKE '%반차%'
                            AND vt.vacation_type_name NOT LIKE '%병가%'
                            THEN TIMESTAMPDIFF(DAY, vlog.start_date, vlog.end_date) + 1
                        ELSE 0
                        END
            ) AS otherLeaveDays
        FROM tbl_vacation_log vlog
                 LEFT JOIN tbl_vacation_type vt ON vlog.vacation_type_id = vt.vacation_type_id
        WHERE vlog.employee_id = #{employeeId}
          AND vlog.status = 'APPROVED'
          AND vlog.start_date BETWEEN #{startDate} AND #{endDate}
    </select>

    <!-- 9) 결재 현황 조회 -->
    <select id="selectApprovalStats" resultType="com.c4.hero.domain.dashboard.dto.ApprovalStatsDTO" parameterType="map">
        SELECT
            SUM(CASE WHEN doc.doc_status IN ('INPROGRESS') THEN 1 ELSE 0 END) AS pendingCount,
            SUM(CASE WHEN doc.doc_status = 'APPROVED' THEN 1 ELSE 0 END) AS approvedCount,
            SUM(CASE WHEN doc.doc_status = 'REJECTED' THEN 1 ELSE 0 END) AS rejectedCount
        FROM tbl_approval_document doc
        WHERE doc.drafter_id = #{employeeId}
    </select>

    <!-- 10) 근무제 템플릿 정보 조회 -->
    <select id="selectWorkSystemTemplate" resultType="com.c4.hero.domain.dashboard.dto.WorkSystemTemplateDTO">
        SELECT
            work_system_template_id AS workSystemTemplateId,
            start_time AS startTime,
            end_time AS endTime,
            break_min_minutes AS breakMinMinutes,
            reason,
            work_system_type_id AS workSystemTypeId
        FROM tbl_work_system_template
        WHERE work_system_template_id = #{workSystemTemplateId}
    </select>

    <!-- 11) 사원의 기본 근무제 템플릿 ID 조회 -->
    <select id="selectEmployeeDefaultTemplateId" resultType="java.lang.Integer">
        SELECT default_work_system_template_id
        FROM tbl_employee
        WHERE employee_id = #{employeeId}
    </select>
</mapper>