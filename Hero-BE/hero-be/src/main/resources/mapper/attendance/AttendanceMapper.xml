<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ============================================================
    File Name  : AttendanceMapper.xml
    Description: 근태(Attendance) 관련 데이터를 조회하는 MyBatis 매퍼 XML

    History
    2025/12/09 (이지윤) 최초 작성 및 컨벤션 적용
    2025/12/30 (이지윤) 지연 출근 수정 로직 관련 쿼리문 추가
    2025/12/30 (이지윤) 초과 근무 로직 추가
    2025/12/31 (이지윤) 근무제 변경 로직 추가
    2026/01/02 (혜원) 근태 관련 알림 로직 추가
    ============================================================
-->

<mapper namespace="com.c4.hero.domain.attendance.mapper.AttendanceMapper">

    <!-- ============================================================
         1) 개인 근태 기록 ResultMap
            PersonalDTO 매핑 정의
         ============================================================ -->
    <resultMap id="PersonalMap" type="com.c4.hero.domain.attendance.dto.PersonalDTO">
        <result property="attendanceId"   column="attendance_id"/>
        <result property="workDate"       column="work_date"/>
        <result property="state"          column="state"/>
        <result property="startTime"      column="start_time"/>
        <result property="endTime"        column="end_time"/>
        <result property="workDuration"   column="work_duration"/>
        <result property="workSystemName" column="work_system_name"/>
    </resultMap>

    <!-- ============================================================
         1-2) 초과 근무 기록 ResultMap
              OvertimeDTO 매핑 정의
         ============================================================ -->
    <resultMap id="OvertimeMap" type="com.c4.hero.domain.attendance.dto.OvertimeDTO">
        <result property="overtimeId"    column="overtime_id"/>
        <result property="date"          column="date"/>
        <result property="startTime"     column="start_time"/>
        <result property="endTime"       column="end_time"/>
        <result property="overtimeHours" column="overtime_hours"/>
        <result property="reason"        column="reason"/>
    </resultMap>

    <!-- ============================================================
         1-3) 근태 정정 기록 ResultMap
              CorrectionDTO 매핑 정의
         ============================================================ -->
    <resultMap id="CorrectionMap" type="com.c4.hero.domain.attendance.dto.CorrectionDTO">
        <!-- 근태 정정 요청 기본 정보 -->
        <result property="correctionId" column="correction_request_id"/>
        <result property="date"         column="target_date"/>
        <result property="reason"       column="reason"/>

        <!-- 정정 전 출퇴근 시간 (기존 근태 기록) -->
        <result property="prevStartTime" column="start_time"/>
        <result property="prevEndTime"   column="end_time"/>

        <!-- 정정 후 출퇴근 시간 (요청 값) -->
        <result property="newStartTime" column="corrected_start"/>
        <result property="newEndTime"   column="corrected_end"/>
    </resultMap>

    <!-- ============================================================
         1-4) 근무제 변경 이력 ResultMap
              ChangeLogDTO 매핑 정의
         ============================================================ -->
    <resultMap id="ChangeLogMap" type="com.c4.hero.domain.attendance.dto.ChangeLogDTO">
        <result property="workSystemChangeLogId" column="work_system_change_log_id"/>
        <result property="date"                  column="date"/>
        <result property="changeReason"          column="change_reason"/>
        <result property="startTime"             column="start_time"/>
        <result property="endTime"               column="end_time"/>
        <result property="workSystemName"        column="template_name"/>
    </resultMap>

    <!-- ============================================================
         2-0)  근태 기록 상단 요약
            AttendanceMapper.selectPersonalSummary(...)
        ============================================================ -->
    <select id="selectPersonalSummary"
            resultType="com.c4.hero.domain.attendance.dto.AttSummaryDTO"
            parameterType="map" >
        SELECT
            SUM(CASE WHEN att.state = '정상' THEN 1 ELSE 0 END) AS workDays,
            SUM(CASE WHEN att.state = '지각' THEN 1 ELSE 0 END) AS lateCount,
            SUM(CASE WHEN att.state = '결근' THEN 1 ELSE 0 END) AS absentCount,
            SUM(CASE WHEN att.state = '조퇴' THEN 1 ELSE 0 END) AS earlyCount,
            (
                SELECT wst.name
                FROM tbl_attendance att2
                         JOIN tbl_work_system_type wst
                              ON wst.work_system_type_id = att2.work_system_type_id
                WHERE att2.employee_id = #{employeeId}
                  AND att2.work_date = CURDATE()
                                                                 LIMIT 1
            ) AS todayWorkSystemName
        FROM tbl_attendance att
        WHERE att.employee_id = #{employeeId}
          AND att.work_date BETWEEN #{startDate} AND #{endDate}

    </select>

    <!-- ============================================================
         2-1) 개인 근태 기록 SELECT (페이지 조회)
            AttendanceMapper.selectPersonalPage(...)
         ============================================================ -->
    <select id="selectPersonalPage" resultMap="PersonalMap" parameterType="map">
        SELECT
        att.attendance_id,
        att.work_date,
        att.state,
        att.start_time,
        att.end_time,
        att.work_duration,
        wst.name AS work_system_name
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            AND att.employee_id = #{employeeId}
            <if test="startDate != null">

                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY att.work_date DESC, att.attendance_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         2-2) 개인 근태 기록 총 개수 조회
            AttendanceMapper.selectPersonalCount(...)
         ============================================================ -->
    <select id="selectPersonalCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            AND att.employee_id = #{employeeId}

            <if test="startDate != null">
                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- ============================================================
         2-3) 개인 근태 기록 단건 조회
            AttendanceMapper.selectPersonalById(...)
     ============================================================ -->
    <select id="selectPersonalById" resultMap="PersonalMap" parameterType="map">
        SELECT
            att.attendance_id,
            att.work_date,
            att.state,
            att.start_time,
            att.end_time,
            COALESCE(
                    TIMESTAMPDIFF(MINUTE, att.start_time, att.end_time),
                    0
            ) AS work_duration,
            wst.name AS work_system_name
        FROM tbl_attendance att
                 JOIN tbl_work_system_type wst
                      ON att.work_system_type_id = wst.work_system_type_id
        WHERE att.employee_id = #{employeeId}
          AND att.attendance_id = #{attendanceId}
            LIMIT 1
    </select>

    <!-- ============================================================
         2-4) 근태 정정 요청 등록
            AttendanceMapper.insertCorrectionRequest(...)
     ============================================================ -->
    <insert id="insertCorrectionRequest">
        INSERT INTO tbl_attendance_correction_request
        (
            target_date,
            corrected_start,
            corrected_end,
            reason,
            attendance_id,
            employee_id
        )
        VALUES
            (
                #{targetDate},
                #{correctedStart},
                #{correctedEnd},
                #{reason},
                #{attendanceId},
                #{employeeId}
            )
    </insert>

    <!-- ============================================================
         3-1) 초과 근무(Overtime) 기록 SELECT (페이지 조회)
            AttendanceMapper.selectOvertimePage(...)
         ============================================================ -->
    <select id="selectOvertimePage" resultMap="OvertimeMap" parameterType="map">
        SELECT
        ove.overtime_id,
        ove.date,
        ove.start_time,
        ove.end_time,
        ove.overtime_hours,
        ove.reason
        FROM tbl_overtime ove
        <where>
            AND ove.employee_id = #{employeeId}
            <if test="startDate != null">
                AND ove.date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND ove.date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY ove.date DESC, ove.overtime_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         3-2) 초과 근무(Overtime) 기록 총 개수 조회
            AttendanceMapper.selectOvertimeCount(...)
         ============================================================ -->
    <select id="selectOvertimeCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_overtime ove
        <where>
            AND ove.employee_id = #{employeeId}
            <if test="startDate != null">
                AND ove.date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND ove.date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- ============================================================
      3-3) 초과 근무 등록
         AttendanceMapper.insertOvertime(...)
      ============================================================ -->
    <insert id="insertOvertime">
        INSERT INTO tbl_overtime
        (
            date,
            start_time,
            end_time,
            overtime_hours,
            reason,
            employee_id
        )
        VALUES
            (
                #{workDate},
                #{startTime},
                #{endTime},
                #{overtimeHours},
                #{reason},
                #{employeeId}
            )
    </insert>

    <!-- ============================================================
         4-1) 근태 정정(Correction) 기록 SELECT (페이지 조회)
            AttendanceMapper.selectCorrectionPage(...)
         ============================================================ -->
    <select id="selectCorrectionPage" resultMap="CorrectionMap" parameterType="map">
        SELECT
        cor.correction_request_id,
        cor.target_date,
        cor.corrected_start,
        cor.corrected_end,
        cor.reason,
        att.start_time,
        att.end_time
        FROM tbl_attendance_correction_request cor
        JOIN tbl_attendance att
        ON cor.attendance_id = att.attendance_id
        <where>
            AND cor.employee_id = #{employeeId}
            <if test="startDate != null">
                AND cor.target_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND cor.target_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY cor.target_date DESC, cor.correction_request_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         4-2) 근태 정정(Correction) 기록 총 개수 조회
            AttendanceMapper.selectCorrectionCount(...)
         ============================================================ -->
    <select id="selectCorrectionCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_attendance_correction_request cor
        JOIN tbl_attendance att
        ON cor.attendance_id = att.attendance_id
        <where>
            AND cor.employee_id = #{employeeId}
            <if test="startDate != null">
                AND cor.target_date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND cor.target_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- ============================================================
         5-1) 근무제 변경 이력(Change Log) SELECT (페이지 조회)
            AttendanceMapper.selectChangeLogPage(...)
         ============================================================ -->
    <select id="selectChangeLogPage" resultMap="ChangeLogMap" parameterType="map">
        SELECT
        cha.work_system_change_log_id,
        cha.date,
        cha.change_reason,
        cha.start_time,
        cha.end_time,
        cha.template_name
        FROM tbl_work_system_change_log cha
        <where>
            AND cha.employee_id = #{employeeId}
            <if test="startDate != null">
                AND cha.date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND cha.date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY cha.date DESC, cha.work_system_change_log_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         5-2) 근무제 변경 이력(Change Log) 총 개수 조회
            AttendanceMapper.selectChangeLogCount(...)
         ============================================================ -->
    <select id="selectChangeLogCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_work_system_change_log cha
        <where>
            AND cha.employee_id = #{employeeId}
            <if test="startDate != null">
                AND cha.date &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND cha.date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- ============================================================
         5-3) 근무제 변경 이름 출력
     ============================================================ -->
    <select id="selectWorkSystemNameByAnyId" resultType="string" parameterType="int">
        SELECT
            CASE
                WHEN EXISTS (
                    SELECT 1
                    FROM tbl_work_system_type
                    WHERE work_system_type_id = #{id}
                )
                    THEN (
                    SELECT name
                    FROM tbl_work_system_type
                    WHERE work_system_type_id = #{id}
                )
                WHEN EXISTS (
                    SELECT 1
                    FROM tbl_work_system_template
                    WHERE work_system_template_id = #{id}
                )
                    THEN (
                    SELECT reason
                    FROM tbl_work_system_template
                    WHERE work_system_template_id = #{id}
                )
                ELSE NULL
                END AS template_name
    </select>

    <!-- ============================================================
        5-4) 근무제 정정 요청 등록
        AttendanceMapper.insertWorkSystemChangeLog( ... )
 ============================================================ -->
    <insert id="insertWorkSystemChangeLog" parameterType="map">
        INSERT INTO tbl_work_system_change_log (
            date,
            change_reason,
            template_name,
            start_time,
            end_time,
            work_system_template_id,
            employee_id
        )
        VALUES (
                   #{date},
                   #{changeReason},
                   #{templateName},
                   #{startTime},
                   #{endTime},
                   #{workSystemTemplateId},
                   #{employeeId}
               )
    </insert>

    <!-- @author 혜원 -->
    <!-- 출근 버튼 누르고 지각 시에 알림   -->
    <select id="selectClockInMissingEmployees" resultType="map">
        SELECT
            e.employee_id AS employeeId,
            a.attendance_id AS attendanceId
        FROM tbl_employee e
                 LEFT JOIN tbl_attendance a ON e.employee_id = a.employee_id
            AND a.work_date = #{workDate}
        WHERE e.status = 'A' -- 재직 중인 사원 중에서
          AND (
            a.attendance_id IS NULL -- 오늘 근태 기록 자체가 없거나
                OR a.start_time IS NULL -- 기록은 있는데 출근 버튼을 안 눌렀을 때
            )
    </select>

    <!-- 지각알림을 위한 나의 근무제 조회 (데이터 없을 경우 9시 기준) -->
    <select id="selectCurrentWorkSystem" resultType="map">
        SELECT
            /* 템플릿이 없으면 기본 09:00:00으로 지각 판단을 진행함 */
            COALESCE(wst.start_time, '09:00:00') AS scheduledStartTime,
            a.attendance_id AS attendanceId
        FROM tbl_attendance a
                 LEFT JOIN tbl_work_system_template wst
                           ON a.work_system_template_id = wst.work_system_template_id
        WHERE a.employee_id = #{employeeId}
          AND a.work_date = #{workDate}
    </select>

    <select id="selectBreakMinMinutes" parameterType="_int" resultType="int">
        SELECT wst.break_min_minutes
        FROM tbl_attendance a
                 INNER JOIN tbl_work_system_template wst
                            ON a.work_system_template_id = wst.work_system_template_id
                 INNER JOIN tbl_work_system_type wstype
                            ON wst.work_system_type_id = wstype.work_system_type_id
        WHERE a.attendance_id = #{attendanceId}
    </select>

</mapper>