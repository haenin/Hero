<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.c4.hero.domain.approval.mapper.ApprovalMapper">

    <resultMap id="approvalDefaultLineResultMap" type="com.c4.hero.domain.approval.dto.ApprovalDefaultLineDTO">
        <result property="approverId"     column="approver_id"/>
        <result property="approverName"   column="approver_name"/>
        <result property="departmentId"   column="department_id"/>
        <result property="departmentName" column="department_name"/>
        <result property="gradeName"      column="grade_name"/>
        <result property="jobTitleName"   column="job_title_name"/>
        <result property="seq"            column="seq"/>
    </resultMap>

    <resultMap id="approvalDefaultRefResultMap" type="com.c4.hero.domain.approval.dto.ApprovalDefaultRefDTO">
        <result property="referencerId"   column="referencer_id"/>
        <result property="referencerName" column="referencer_name"/>
        <result property="departmentId"   column="department_id"/>
        <result property="departmentName" column="department_name"/>
        <result property="gradeName"      column="grade_name"/>
        <result property="jobTitleName"   column="job_title_name"/>
    </resultMap>

    <select id="selectDefaultLines" resultMap="approvalDefaultLineResultMap">
        -- 기안자 정보 조회 (WITH 절로 미리 가져오기)
        WITH drafter_info AS (
            SELECT
                e.employee_id,
                e.department_id,
                d.manager_id,
                d.parent_department_id
            FROM tbl_employee e
                     INNER JOIN tbl_department d ON d.department_id = e.department_id
            WHERE e.employee_id = #{employeeId}
        )
        SELECT
            M.employee_id      AS approver_id,
            M.employee_name    AS approver_name,
            D.department_id    AS department_id,
            D.department_name  AS department_name,
            G.grade            AS grade_name,
            J.job_title        AS job_title_name,
            L.seq              AS seq
        FROM tbl_approval_default_line L
                 CROSS JOIN drafter_info DI  -- 기안자 정보를 모든 행에서 참조

        -- 타겟 부서 결정
                 INNER JOIN tbl_department D ON D.department_id = (
            CASE
                -- 특정 부서 지정
                WHEN L.department_id > 0 THEN L.department_id

                -- seq=2 (1차 결재): 기안자의 직속부서 또는 상위 부서
                WHEN L.seq = 2 THEN (
                    CASE
                        -- 기안자가 부서장인 경우 → 상위 부서
                        WHEN DI.employee_id = DI.manager_id THEN DI.parent_department_id
                        -- 기안자가 일반 직원인 경우 → 현재 부서
                        ELSE DI.department_id
                        END
                    )

                -- seq=3 (2차 결재): 1차 결재자의 상위 부서
                WHEN L.seq = 3 THEN (
                    SELECT PD.department_id
                    FROM tbl_department CD
                             INNER JOIN tbl_department PD ON PD.department_id = CD.parent_department_id
                    WHERE CD.department_id = DI.department_id
                )

                --                 -- seq=4 (3차 결재): 2차 결재자의 상위 부서
--                 WHEN L.seq = 4 THEN (
--                     SELECT PPD.department_id
--                     FROM tbl_department CD
--                              INNER JOIN tbl_department PD ON PD.department_id = CD.parent_department_id
--                              INNER JOIN tbl_department PPD ON PPD.department_id = PD.parent_department_id
--                     WHERE CD.department_id = DI.department_id
--                 )

                ELSE NULL
                END
            )

            -- 부서장 조인
                 INNER JOIN tbl_employee M ON D.manager_id = M.employee_id

            -- 직급/직책
                 LEFT JOIN tbl_grade G ON M.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON M.job_title_id = J.job_title_id

        WHERE L.template_id = #{templateId}
          AND L.seq > 1
          -- 기안자와 동일한 결재자 제외 (기안자가 부서장인 경우 자기 자신 제외)
          AND M.employee_id != #{employeeId}
        ORDER BY L.seq ASC
    </select>

    <select id="selectDefaultReferences" resultMap="approvalDefaultRefResultMap">
        SELECT
            M.employee_id      AS referencer_id,
            M.employee_name         AS referencer_name,
            D.department_id    AS department_id,
            D.department_name        AS department_name,
            G.grade      AS grade_name,
            J.job_title   AS job_title_name
        FROM tbl_approval_default_reference R
                 /* 기안자(Me) 정보 */
                 LEFT JOIN tbl_employee Me ON Me.employee_id = #{employeeId}
            /* 타겟 부서 결정 */
                 INNER JOIN tbl_department D
                            ON D.department_id = (CASE WHEN R.department_id = 0 THEN Me.department_id ELSE R.department_id END)
            /* 부서장(Manager) 조인 (수신자) */
                 INNER JOIN tbl_employee M ON D.manager_id = M.employee_id
            /* 직급/직책 정보 */
                 LEFT JOIN tbl_grade G ON M.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON M.job_title_id = J.job_title_id
        WHERE R.template_id = #{templateId}
    </select>

    <!-- 문서함 목록 조회 -->
    <resultMap id="approvalDocumentsResultMap" type="com.c4.hero.domain.approval.dto.response.ApprovalDocumentsResponseDTO">
        <result property="docId"         column="doc_id"/>
        <result property="docNo"         column="doc_no"/>
        <result property="docStatus"     column="doc_status"/>
        <result property="category"      column="category"/>
        <result property="name"          column="name"/>
        <result property="title"         column="title"/>
        <result property="drafterDept"   column="drafter_dept"/>
        <result property="drafter"       column="drafter"/>
        <result property="drafterAt"     column="draft_date"/>
    </resultMap>

    <!-- 문서함 목록 조회 (탭별 필터링) -->
    <select id="selectInboxDocuments" resultMap="approvalDocumentsResultMap">
        SELECT
        D.doc_id            AS doc_id,
        D.doc_no            AS doc_no,
        D.doc_status        AS doc_status,
        T.category          AS category,
        T.template_name     AS name,
        D.title             AS title,
        DEPT.department_name AS drafter_dept,
        E.employee_name     AS drafter,
        DATE_FORMAT(D.draft_date, '%Y년 %m월 %d일') AS draft_date
        FROM tbl_approval_document D
        INNER JOIN tbl_approval_form_template T ON D.template_id = T.template_id
        INNER JOIN tbl_employee E ON D.drafter_id = E.employee_id
        INNER JOIN tbl_department DEPT ON E.department_id = DEPT.department_id
        <where>
            <!-- 탭별 필터링 -->
            <choose>
                <!-- 전체: 기안자이거나 결재선/참조에 포함된 모든 문서 (단, 남이 임시저장한 문서는 제외) -->
                <when test="tab == 'all'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    )
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id AND AR.emp_id = #{employeeId}
                    ))
                    <!-- 남이 임시저장한 문서는 제외 -->
                    AND NOT (D.doc_status = 'DRAFT' AND D.drafter_id != #{employeeId})
                </when>

                <!-- 대기: 본인이 상신한 진행중인 문서 -->
                <when test="tab == 'que'">
                    D.drafter_id = #{employeeId}
                    AND D.doc_status = 'INPROGRESS'
                </when>

                <!-- 요청: 결재 대기 중인 문서 (본인이 결재해야 하는 문서) -->
                <when test="tab == 'request'">
                    EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id
                    AND AL.approver_id = #{employeeId}
                    AND AL.line_status = 'PENDING'
                    AND D.doc_status = 'INPROGRESS'
                    )
                </when>

                <!-- 반려: 반려된 문서 (본인이 상신했거나 결재선에 포함된 문서 중 반려) -->
                <when test="tab == 'reject'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    ))
                    AND D.doc_status = 'REJECTED'
                </when>

                <!-- 참조: 참조자로 지정된 문서 -->
                <when test="tab == 'ref'">
                    EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id AND AR.emp_id = #{employeeId}
                    )
                    AND D.doc_status != 'DRAFT'
                </when>

                <!-- 승인: 완료된 문서 (본인이 승인했거나 상신한 문서 중 최종 승인) -->
                <when test="tab == 'end'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    )
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id AND AR.emp_id = #{employeeId}
                    ))
                    AND D.doc_status = 'APPROVED'
                </when>

                <!-- 임시저장: 본인이 작성한 임시저장 문서 -->
                <when test="tab == 'draft'">
                    D.drafter_id = #{employeeId}
                    AND D.doc_status = 'DRAFT'
                </when>
            </choose>

            <!-- 날짜 필터 -->
            <if test="fromDate != null and fromDate != ''">
                AND D.draft_date >= #{fromDate}
            </if>
            <if test="toDate != null and toDate != ''">
                AND D.draft_date <![CDATA[<=]]> #{toDate}
            </if>

            <!-- 검색 조건 필터 -->
            <if test="condition != null and condition != ''">
                <choose>
                    <!-- 전체 검색: 모든 필드에서 OR 조건으로 검색 -->
                    <when test="sortBy == null or sortBy == '' or sortBy == 'all'">
                        AND (
                        D.doc_no LIKE CONCAT('%', #{condition}, '%')
                        OR T.category LIKE CONCAT('%', #{condition}, '%')
                        OR T.template_name LIKE CONCAT('%', #{condition}, '%')
                        OR D.title LIKE CONCAT('%', #{condition}, '%')
                        OR DEPT.department_name LIKE CONCAT('%', #{condition}, '%')
                        OR E.employee_name LIKE CONCAT('%', #{condition}, '%')
                        )
                    </when>
                    <!-- 개별 필드 검색 -->
                    <when test="sortBy == 'docNo'">
                        AND D.doc_no LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'docType'">
                        AND T.category LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'name'">
                        AND T.template_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'title'">
                        AND D.title LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'dept'">
                        AND DEPT.department_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'drafter'">
                        AND E.employee_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                </choose>
            </if>
        </where>

        <!-- 기본 정렬: 최신순 (상신일시 내림차순) -->
        ORDER BY D.draft_date DESC

        <!-- 페이징 처리 -->
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 문서함 전체 개수 조회 (페이징용) -->
    <select id="countInboxDocuments" resultType="_int">
        SELECT COUNT(*)
        FROM tbl_approval_document D
        INNER JOIN tbl_approval_form_template T ON D.template_id = T.template_id
        INNER JOIN tbl_employee E ON D.drafter_id = E.employee_id
        INNER JOIN tbl_department DEPT ON E.department_id = DEPT.department_id
        <where>
            <!-- 탭별 필터링 -->
            <choose>
                <!-- 전체: 기안자이거나 결재선/참조에 포함된 모든 문서 (단, 남이 임시저장한 문서는 제외) -->
                <when test="tab == 'all'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    )
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id AND AR.emp_id = #{employeeId}
                    ))
                    AND NOT (D.doc_status = 'DRAFT' AND D.drafter_id != #{employeeId})
                </when>

                <!-- 대기: 본인이 상신한 문서 -->
                <when test="tab == 'que'">
                    D.drafter_id = #{employeeId}
                    AND D.doc_status = 'INPROGRESS'
                </when>

                <!-- 요청: 결재 대기 중인 문서 (본인이 결재해야 하는 문서) -->
                <when test="tab == 'request'">
                    EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id
                    AND AL.approver_id = #{employeeId}
                    AND AL.line_status = 'PENDING'
                    AND D.doc_status = 'INPROGRESS'
                    )
                </when>

                <!-- 반려: 반려된 문서 -->
                <when test="tab == 'reject'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    ))
                    AND D.doc_status = 'REJECTED'
                </when>

                <!-- 참조: 참조자로 지정된 문서 -->
                <when test="tab == 'ref'">
                    EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id
                    AND AR.emp_id = #{employeeId}
                    )
                    AND D.doc_status != 'DRAFT'
                </when>

                <!-- 승인: 승인 완료된 문서 -->
                <when test="tab == 'end'">
                    (D.drafter_id = #{employeeId}
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_line AL
                    WHERE AL.doc_id = D.doc_id AND AL.approver_id = #{employeeId}
                    )
                    OR EXISTS (
                    SELECT 1 FROM tbl_approval_reference AR
                    WHERE AR.doc_id = D.doc_id AND AR.emp_id = #{employeeId}
                    ))
                    AND D.doc_status = 'APPROVED'
                </when>

                <!-- 임시저장: 본인이 임시저장한 문서 -->
                <when test="tab == 'draft'">
                    D.drafter_id = #{employeeId}
                    AND D.doc_status = 'DRAFT'
                </when>
            </choose>

            <!-- 날짜 필터링 -->
            <if test="fromDate != null and fromDate != ''">
                AND D.draft_date >= #{fromDate}
            </if>
            <if test="toDate != null and toDate != ''">
                AND D.draft_date <![CDATA[<=]]> #{toDate}
            </if>

            <!-- 검색 조건 -->
            <if test="condition != null and condition != ''">
                <choose>
                    <!-- 전체 검색: 모든 필드에서 OR 조건으로 검색 -->
                    <when test="sortBy == null or sortBy == '' or sortBy == 'all'">
                        AND (
                        D.doc_no LIKE CONCAT('%', #{condition}, '%')
                        OR T.category LIKE CONCAT('%', #{condition}, '%')
                        OR T.template_name LIKE CONCAT('%', #{condition}, '%')
                        OR D.title LIKE CONCAT('%', #{condition}, '%')
                        OR DEPT.department_name LIKE CONCAT('%', #{condition}, '%')
                        OR E.employee_name LIKE CONCAT('%', #{condition}, '%')
                        )
                    </when>
                    <!-- 개별 필드 검색 -->
                    <when test="sortBy == 'docNo'">
                        AND D.doc_no LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'docType'">
                        AND T.category LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'name'">
                        AND T.template_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'title'">
                        AND D.title LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'dept'">
                        AND DEPT.department_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                    <when test="sortBy == 'drafter'">
                        AND E.employee_name LIKE CONCAT('%', #{condition}, '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <!-- 나머지 쿼리들은 모두 그대로 유지 -->
    <resultMap id="approvalDocumentDetailResultMap" type="com.c4.hero.domain.approval.dto.response.ApprovalDocumentDetailResponseDTO">
        <result property="docId" column="doc_id"/>
        <result property="docNo" column="doc_no"/>
        <result property="docStatus" column="doc_status"/>
        <result property="templateId" column="template_id"/>
        <result property="templateName" column="template_name"/>
        <result property="templateKey" column="template_key"/>
        <result property="category" column="category"/>
        <result property="title" column="title"/>
        <result property="drafterId" column="drafter_id"/>
        <result property="drafter" column="drafter"/>
        <result property="drafterDept" column="drafter_dept"/>
        <result property="drafterGrade" column="drafter_grade"/>
        <result property="draftDate" column="draft_date"/>
        <result property="submittedAt" column="submitted_at"/>
        <result property="completedAt" column="completed_at"/>
        <result property="details" column="details"/>
    </resultMap>

    <select id="selectDocumentDetail" resultMap="approvalDocumentDetailResultMap">
        SELECT
            D.doc_id AS doc_id,
            D.doc_no AS doc_no,
            D.doc_status AS doc_status,
            D.template_id AS template_id,
            T.template_name AS template_name,
            T.template_key AS template_key,
            T.category AS category,
            D.title AS title,
            D.drafter_id AS drafter_id,
            E.employee_name AS drafter,
            DEPT.department_name AS drafter_dept,
            G.grade AS drafter_grade,
            DATE_FORMAT(D.draft_date, '%Y-%m-%d') AS draft_date,
            D.created_at AS submitted_at,
            D.end_date AS completed_at,
            D.details AS details
        FROM tbl_approval_document D
                 INNER JOIN tbl_approval_form_template T ON D.template_id = T.template_id
                 INNER JOIN tbl_employee E ON D.drafter_id = E.employee_id
                 INNER JOIN tbl_department DEPT ON E.department_id = DEPT.department_id
                 LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
        WHERE D.doc_id = #{docId}
    </select>

    <resultMap id="approvalLineResultMap" type="com.c4.hero.domain.approval.dto.response.ApprovalLineResponseDTO">
        <result property="lineId" column="line_id"/>
        <result property="approverId" column="approver_id"/>
        <result property="approverName" column="approver_name"/>
        <result property="departmentName" column="department_name"/>
        <result property="gradeName" column="grade_name"/>
        <result property="jobTitleName" column="job_title_name"/>
        <result property="seq" column="seq"/>
        <result property="status" column="status"/>
        <result property="approvedAt" column="approved_at"/>
        <result property="comment" column="comment"/>
    </resultMap>

    <select id="selectApprovalLines" resultMap="approvalLineResultMap">
        SELECT
            AL.line_id AS line_id,
            AL.approver_id AS approver_id,
            E.employee_name AS approver_name,
            D.department_name AS department_name,
            G.grade AS grade_name,
            J.job_title AS job_title_name,
            AL.seq AS seq,
            AL.line_status AS status,
            AL.process_date AS approved_at,
            AL.comment AS comment
        FROM tbl_approval_line AL
                 INNER JOIN tbl_employee E ON AL.approver_id = E.employee_id
                 LEFT JOIN tbl_department D ON E.department_id = D.department_id
                 LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON E.job_title_id = J.job_title_id
        WHERE AL.doc_id = #{docId}
        ORDER BY AL.seq ASC
    </select>

    <resultMap id="approvalReferenceResultMap" type="com.c4.hero.domain.approval.dto.response.ApprovalReferenceResponseDTO">
        <result property="referenceId" column="reference_id"/>
        <result property="referencerId" column="referencer_id"/>
        <result property="referencerName" column="referencer_name"/>
        <result property="departmentName" column="department_name"/>
        <result property="gradeName" column="grade_name"/>
        <result property="jobTitleName" column="job_title_name"/>
    </resultMap>

    <select id="selectApprovalReferences" resultMap="approvalReferenceResultMap">
        SELECT
            AR.ref_id AS reference_id,
            AR.emp_id AS referencer_id,
            E.employee_name AS referencer_name,
            D.department_name AS department_name,
            G.grade AS grade_name,
            J.job_title AS job_title_name
        FROM tbl_approval_reference AR
                 INNER JOIN tbl_employee E ON AR.emp_id = E.employee_id
                 LEFT JOIN tbl_department D ON E.department_id = D.department_id
                 LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON E.job_title_id = J.job_title_id
        WHERE AR.doc_id = #{docId}
    </select>

    <resultMap id="approvalAttachmentResultMap" type="com.c4.hero.domain.approval.dto.response.ApprovalAttachmentResponseDTO">
        <result property="attachmentId" column="attachment_id"/>
        <result property="originalFilename" column="original_filename"/>
        <result property="storedFilename" column="stored_filename"/>
        <result property="fileSize" column="file_size"/>
        <result property="fileUrl" column="file_url"/>
        <result property="uploadedAt" column="uploaded_at"/>
    </resultMap>

    <select id="selectApprovalAttachments" resultMap="approvalAttachmentResultMap">
        SELECT
            file_id AS attachment_id,
            origin_name AS original_filename,
            file_size AS file_size,
            save_path AS file_url,
            uploaded_at AS uploaded_at
        FROM tbl_approval_attachment
        WHERE doc_id = #{docId}
        ORDER BY attachment_id ASC
    </select>

</mapper>