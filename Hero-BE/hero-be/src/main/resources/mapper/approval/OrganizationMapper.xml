<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.c4.hero.domain.approval.mapper.OrganizationMapper">

    <!-- ============================================================ -->
    <!-- ResultMap 정의 -->
    <!-- ============================================================ -->

    <!-- 부서 정보 ResultMap -->
    <resultMap id="departmentResultMap" type="com.c4.hero.domain.approval.dto.organization.OrganizationDepartmentDTO">
        <result property="departmentId"       column="department_id"/>
        <result property="departmentName"     column="department_name"/>
        <result property="depth"              column="depth"/>
        <result property="parentDepartmentId" column="parent_department_id"/>
        <result property="managerId"          column="manager_id"/>
        <result property="managerName"        column="manager_name"/>
        <result property="employeeCount"      column="employee_count"/>
    </resultMap>

    <!-- 직원 정보 ResultMap -->
    <resultMap id="employeeResultMap" type="com.c4.hero.domain.approval.dto.organization.OrganizationEmployeeDTO">
        <result property="employeeId"     column="employee_id"/>
        <result property="employeeName"   column="employee_name"/>
        <result property="departmentId"   column="department_id"/>
        <result property="departmentName" column="department_name"/>
        <result property="gradeId"        column="grade_id"/>
        <result property="gradeName"      column="grade_name"/>
        <result property="jobTitleId"     column="job_title_id"/>
        <result property="jobTitleName"   column="job_title_name"/>
        <result property="email"          column="email"/>
        <result property="phone"          column="phone"/>
    </resultMap>


    <!-- ============================================================ -->
    <!-- 모든 부서 조회 -->
    <!-- ============================================================ -->
    <select id="selectAllDepartments" resultMap="departmentResultMap">
        SELECT
            D.department_id,
            D.department_name,
            D.depth,
            D.parent_department_id,
            D.manager_id,
            M.employee_name AS manager_name,
            (SELECT COUNT(*)
             FROM tbl_employee E
             WHERE E.department_id = D.department_id) AS employee_count
        FROM tbl_department D
                 LEFT JOIN tbl_employee M ON D.manager_id = M.employee_id
        ORDER BY D.depth ASC, D.department_id ASC
    </select>


    <!-- ============================================================ -->
    <!-- 모든 직원 조회 -->
    <!-- ============================================================ -->
    <select id="selectAllEmployees" resultMap="employeeResultMap">
        SELECT
            E.employee_id,
            E.employee_name,
            E.department_id,
            D.department_name,
            E.grade_id,
            G.grade AS grade_name,
            E.job_title_id,
            J.job_title AS job_title_name,
            E.email,
            E.phone
        FROM tbl_employee E
                 INNER JOIN tbl_department D ON E.department_id = D.department_id
                 LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON E.job_title_id = J.job_title_id
        WHERE E.status = 'A'
        ORDER BY E.department_id ASC, E.grade_id DESC, E.employee_name ASC
    </select>


    <!-- ============================================================ -->
    <!-- 직원 검색 -->
    <!-- ============================================================ -->
    <select id="searchEmployees" resultMap="employeeResultMap">
        SELECT
        E.employee_id,
        E.employee_name,
        E.department_id,
        D.department_name,
        E.grade_id,
        G.grade AS grade_name,
        E.job_title_id,
        J.job_title AS job_title_name,
        E.email,
        E.phone
        FROM tbl_employee E
        INNER JOIN tbl_department D ON E.department_id = D.department_id
        LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
        LEFT JOIN tbl_job_title J ON E.job_title_id = J.job_title_id
        WHERE E.status = 'A'
        AND (
        E.employee_name LIKE CONCAT('%', #{keyword}, '%')
        OR D.department_name LIKE CONCAT('%', #{keyword}, '%')
        OR G.grade LIKE CONCAT('%', #{keyword}, '%')
        OR J.job_title LIKE CONCAT('%', #{keyword}, '%')
        )
        <if test="departmentId != null">
            AND E.department_id = #{departmentId}
        </if>
        <if test="gradeId != null">
            AND E.grade_id = #{gradeId}
        </if>
        ORDER BY E.employee_name ASC
        LIMIT 100
    </select>


    <!-- ============================================================ -->
    <!-- 특정 부서의 직원 목록 조회 -->
    <!-- ============================================================ -->
    <select id="selectEmployeesByDepartment" resultMap="employeeResultMap">
        SELECT
            E.employee_id,
            E.employee_name,
            E.department_id,
            D.department_name,
            E.grade_id,
            G.grade AS grade_name,
            E.job_title_id,
            J.job_title AS job_title_name,
            E.email,
            E.phone
        FROM tbl_employee E
                 INNER JOIN tbl_department D ON E.department_id = D.department_id
                 LEFT JOIN tbl_grade G ON E.grade_id = G.grade_id
                 LEFT JOIN tbl_job_title J ON E.job_title_id = J.job_title_id
        WHERE E.department_id = #{departmentId}
          AND E.status = 'A'
        ORDER BY E.grade_id DESC, E.employee_name ASC
    </select>

</mapper>