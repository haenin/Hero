<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
<pre>
 Class Name: EvaluationMapper.xml
 Description: 평가 관련 Mybatis Mapper

 History
 2025/12/12 (김승민) 최초 작성
 2025/01/02 (승건) 직원별 평가 결과 목록 조회 추가
</pre>

@author 김승민
-->

<mapper namespace="com.c4.hero.domain.evaluation.mapper.EvaluationMapper">

    <resultMap id="EvaluationMap" type="com.c4.hero.domain.evaluation.dto.evaluation.EvaluationResponseDTO">
        <id property="evaluationEvaluationId" column="evaluation_id"/>
        <result property="evaluationEmployeeId" column="employee_id"/>
        <result property="evaluationEmployeeName" column="employee_name"/>
        <result property="evaluationDepartmentId" column="department_id"/>
        <result property="evaluationDepartmentName" column="department_name"/>
        <result property="evaluationGradeId" column="grade_id"/>
        <result property="evaluationGrade" column="grade"/>
        <result property="evaluationTemplateId" column="template_id"/>
        <result property="evaluationName" column="name"/>
        <result property="evaluationStatus" column="status"/>
        <result property="evaluationCreatedAt" column="created_at"/>
        <result property="evaluationEndedAt" column="ended_at"/>
        <result property="evaluationTotalRank" column="total_rank"/>
        <result property="evaluationTotalScore" column="total_score"/>
        <result property="evaluationEvaluationGuideId" column="evaluation_guide_id"/>
        <result property="evaluationEvaluationGuideName" column="evaluation_guide_name"/>
        <result property="evaluationEvaluationPeriodId" column="evaluation_guide_id"/>
        <result property="evaluationEvaluationPeriodStart" column="start"/>
        <result property="evaluationEvaluationPeriodEnd" column="end"/>

        <collection property="selectedItems" ofType="com.c4.hero.domain.evaluation.dto.item.SelectedItemResponseDTO">
            <id property="selectedItemSelectedItemId" column="selected_item_id"/>
            <result property="selectedItemEvaluationId" column="selected_item_evaluation_id"/>
            <result property="selectedItemItemId" column="item_id"/>
            <result property="selectedItemItemName" column="item_name"/>
            <result property="selectedItemItemDescription" column="item_description"/>

            <collection property="criterias" ofType="com.c4.hero.domain.evaluation.dto.criteria.CriteriaResponseDTO">
                <id property="criteriaCriteriaId" column="criteria_id"/>
                <result property="criteriaItemId" column="criteria_item_id"/>
                <result property="criteriaRank" column="rank"/>
                <result property="criteriaDescription" column="criteria_description"/>
                <result property="criteriaMinScore" column="min_score"/>
                <result property="criteriaMaxScore" column="max_score"/>
            </collection>
        </collection>

        <collection property="evaluatees" ofType="com.c4.hero.domain.evaluation.dto.evaluatee.EvaluateeResponseDTO">
            <id property="evaluateeEvaluateeId" column="evaluatee_id"/>
            <result property="evaluateeEvaluationId" column="evaluatee_evaluation_id"/>
            <result property="evaluateeEmployeeId" column="evaluatee_employee_id"/>
            <result property="evaluateeEmployeeName" column="evaluatee_employee_name"/>
            <result property="evaluateeGradeId" column="evaluatee_grade_id"/>
            <result property="evaluateeGrade" column="evaluatee_grade"/>
            <result property="evaluateeStatus" column="evaluatee_status"/>
        </collection>

    </resultMap>

    <select id="selectEvaluationIdsWithPaging" resultType="int">
        SELECT evaluation_id
        FROM tbl_evaluation
        ORDER BY created_at DESC, evaluation_id DESC
            LIMIT #{size} OFFSET #{offset}
    </select>


    <select id="selectEvaluationsByIds" resultMap="EvaluationMap">
        SELECT
        e.evaluation_id AS evaluation_id,
        ee.employee_id AS employee_id,
        ee.employee_name AS employee_name,
        d.department_id AS department_id,
        d.department_name AS department_name,
        g.grade_id AS grade_id,
        g.grade AS grade,
        t.template_id AS template_id,
        e.name AS name,
        e.status AS status,
        e.created_at AS created_at,
        e.ended_at AS ended_at,
        e.total_rank AS total_rank,
        e.total_score AS total_score,
        gg.evaluation_guide_id AS evaluation_guide_id,
        gg.name AS evaluation_guide_name,
        p.evaluation_period_id AS evaluation_period_id,
        p.start AS start,
        p.end AS end,

        s.selected_item_id AS selected_item_id,
        e.evaluation_id AS selected_item_evaluation_id,
        tt.item_id AS item_id,
        tt.item AS item_name,
        tt.description AS item_description,

        c.criteria_id AS criteria_id,
        c.item_id AS criteria_item_id,
        c.rank AS rank,
        c.description AS criteria_description,
        c.min_score AS min_score,
        c.max_score AS max_score,

        eee.evaluatee_id AS evaluatee_id,
        e.evaluation_id AS evaluatee_evaluation_id,
        ee2.employee_id AS evaluatee_employee_id,
        ee2.employee_name AS evaluatee_employee_name,
        g2.grade_id AS evaluatee_grade_id,
        g2.grade AS evaluatee_grade,
        eee.status AS evaluatee_status
        FROM tbl_evaluation e
        JOIN tbl_employee ee ON e.employee_id = ee.employee_id
        JOIN tbl_department d ON e.department_id = d.department_id
        JOIN tbl_grade g ON ee.grade_id = g.grade_id
        JOIN tbl_evaluation_template t ON e.template_id = t.template_id
        JOIN tbl_evaluation_guide gg ON e.evaluation_guide_id = gg.evaluation_guide_id
        JOIN tbl_evaluation_period p ON e.evaluation_period_id = p.evaluation_period_id
        JOIN tbl_selected_item s ON e.evaluation_id = s.evaluation_id
        JOIN tbl_template_item tt ON s.item_id = tt.item_id
        JOIN tbl_criteria c ON tt.item_id = c.item_id
        JOIN tbl_evaluatee eee ON e.evaluation_id = eee.evaluation_id
        JOIN tbl_employee ee2 ON eee.employee_id = ee2.employee_id
        JOIN tbl_grade g2 ON ee2.grade_id = g2.grade_id
        WHERE e.evaluation_id IN
        <foreach collection="evaluationIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        ORDER BY FIELD(e.evaluation_id,
        <foreach collection="evaluationIds" item="id" separator=",">
            #{id}
        </foreach>
        )
    </select>

    <select id="countAllEvaluations" resultType="long">
        SELECT COUNT(*)
        FROM tbl_evaluation
    </select>


    <select id="selectAllEvaluation" resultMap="EvaluationMap">
        SELECT
            e.evaluation_id AS evaluation_id,
            ee.employee_id AS employee_id,
            ee.employee_name AS employee_name,
            d.department_id AS department_id,
            d.department_name AS department_name,
            g.grade_id AS grade_id,
            g.grade AS grade,
            t.template_id AS template_id,
            e.name AS name,
            e.status AS status,
            e.created_at AS created_at,
            e.ended_at AS ended_at,
            e.total_rank AS total_rank,
            e.total_score AS total_score,
            gg.evaluation_guide_id AS evaluation_guide_id,
            gg.name AS evaluation_guide_name,
            p.evaluation_period_id AS evaluation_period_id,
            p.start AS start,
            p.end AS end,

            s.selected_item_id AS selected_item_id,
            e.evaluation_id AS selected_item_evaluation_id,
            tt.item_id AS item_id,
            tt.item AS item_name,
            tt.description AS item_description,

            c.criteria_id AS criteria_id,
            c.item_id AS criteria_item_id,
            c.rank AS rank,
            c.description AS criteria_description,
            c.min_score AS min_score,
            c.max_score AS max_score,

            eee.evaluatee_id AS evaluatee_id,
            e.evaluation_id AS evaluatee_evaluation_id,
            ee2.employee_id AS evaluatee_employee_id,
            ee2.employee_name AS evaluatee_employee_name,
            g2.grade_id AS evaluatee_grade_id,
            g2.grade AS evaluatee_grade,
            eee.status AS evaluatee_status
        FROM tbl_evaluation e
        JOIN tbl_employee ee ON e.employee_id = ee.employee_id
        JOIN tbl_department d ON e.department_id = d.department_id
        JOIN tbl_grade g ON ee.grade_id = g.grade_id
        JOIN tbl_evaluation_template t ON e.template_id = t.template_id
        JOIN tbl_evaluation_guide gg ON e.evaluation_guide_id = gg.evaluation_guide_id
        JOIN tbl_evaluation_period p ON e.evaluation_period_id = p.evaluation_period_id
        JOIN tbl_selected_item s ON e.evaluation_id = s.evaluation_id
        JOIN tbl_template_item tt ON s.item_id = tt.item_id
        JOIN tbl_criteria c ON tt.item_id = c.item_id
        JOIN tbl_evaluatee eee ON e.evaluation_id = eee.evaluation_id
        JOIN tbl_employee ee2 ON eee.employee_id = ee2.employee_id
        JOIN tbl_grade g2 ON ee2.grade_id = g2.grade_id
    </select>


    <select id="selectEvaluation" parameterType="int" resultMap="EvaluationMap">
        SELECT
            e.evaluation_id AS evaluation_id,
            ee.employee_id AS employee_id,
            ee.employee_name AS employee_name,
            d.department_id AS department_id,
            d.department_name AS department_name,
            g.grade_id AS grade_id,
            g.grade AS grade,
            t.template_id AS template_id,
            e.name AS name,
            e.status AS status,
            e.created_at AS created_at,
            e.ended_at AS ended_at,
            e.total_rank AS total_rank,
            e.total_score AS total_score,
            gg.evaluation_guide_id AS evaluation_guide_id,
            gg.name AS evaluation_guide_name,
            p.evaluation_period_id AS evaluation_period_id,
            p.start AS start,
            p.end AS end,

            s.selected_item_id AS selected_item_id,
            e.evaluation_id AS selected_item_evaluation_id,
            tt.item_id AS item_id,
            tt.item AS item_name,
            tt.description AS item_description,

            c.criteria_id AS criteria_id,
            c.item_id AS criteria_item_id,
            c.rank AS rank,
            c.description AS criteria_description,
            c.min_score AS min_score,
            c.max_score AS max_score,

            eee.evaluatee_id AS evaluatee_id,
            e.evaluation_id AS evaluatee_evaluation_id,
            ee2.employee_id AS evaluatee_employee_id,
            ee2.employee_name AS evaluatee_employee_name,
            g2.grade_id AS evaluatee_grade_id,
            g2.grade AS evaluatee_grade,
            eee.status AS evaluatee_status
        FROM tbl_evaluation e
            JOIN tbl_employee ee ON e.employee_id = ee.employee_id
            JOIN tbl_department d ON e.department_id = d.department_id
            JOIN tbl_grade g ON ee.grade_id = g.grade_id
            JOIN tbl_evaluation_template t ON e.template_id = t.template_id
            JOIN tbl_evaluation_guide gg ON e.evaluation_guide_id = gg.evaluation_guide_id
            JOIN tbl_evaluation_period p ON e.evaluation_period_id = p.evaluation_period_id
            JOIN tbl_selected_item s ON e.evaluation_id = s.evaluation_id
            JOIN tbl_template_item tt ON s.item_id = tt.item_id
            JOIN tbl_criteria c ON tt.item_id = c.item_id
            JOIN tbl_evaluatee eee ON e.evaluation_id = eee.evaluation_id
            JOIN tbl_employee ee2 ON eee.employee_id = ee2.employee_id
            JOIN tbl_grade g2 ON ee2.grade_id = g2.grade_id
            WHERE e.evaluation_id = #{evaluationId}
    </select>

    <!-- 직원별 평가 결과 목록 조회 -->
    <select id="findEvaluationFormsByEmployeeId" resultType="com.c4.hero.domain.evaluation.dto.response.EmployeeEvaluationListResponseDTO">
        SELECT
            ef.evaluation_id AS evaluationId,
            e.name AS evaluationName,
            ef.total_rank AS totalRank,
            ef.created_at AS createdAt
        FROM tbl_evaluation_form ef
        JOIN tbl_evaluation e ON ef.evaluation_id = e.evaluation_id
        WHERE ef.employee_id = #{employeeId}
        ORDER BY ef.created_at DESC
    </select>

</mapper>